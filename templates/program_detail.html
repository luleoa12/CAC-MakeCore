{% extends 'base.html' %}
{% block head %}
  <title>{{ program.name }} | Program Details</title>
  <link rel="stylesheet" href="/static/css/program_detail.css">

{% endblock %}
{% block content %}


  <div class="program-main-container">
    <div class="program-main-row">
      <div class="program-main-left">
        <div class="program-title">{{ program.name }}</div>
        <div class="program-description">{{ program.description }}</div>
        <div class="program-controls-label">Controls:</div>
        <div class="program-controls">{{ program.controls }}</div>
      </div>
      <div class="program-main-right">
        <div class="program-image-box">
          {% if program.image_url %}
            <img src="{{ program.image_url }}" alt="{{ program.name }}" class="program-image" />
          {% else %}
            <img data-theme-src="/static/themes/orange/img/studio_default.svg" alt="{{ program.name }}" class="program-image" />
          {% endif %}
        </div>
      </div>
    </div>
    <div class="program-bottom-bar">
      <div class="info-section">
        <div class="arrow-vote-row" style="display: flex; gap: 32px; align-items: center; margin-bottom: 12px;">
          <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
            <div style="position:relative; width:64px; height:64px;">
              <img data-theme-src="/static/themes/makecore/img/arrow.svg" alt="Upvote Arrow" class="arrow-upvote-img" id="main-upvote-arrow" style="cursor:pointer; position:absolute; left:0; top:0; z-index:1;">
              <img data-theme-src="/static/themes/makecore/img/voted.svg" alt="Upvoted Overlay" class="arrow-vote-overlay" id="main-upvote-overlay" style="display:{{ '' if user_vote == 'up' else 'none' }}; position:absolute; left:0; top:0; z-index:2; width:64px; height:64px; pointer-events:none;">
            </div>
            <span id="main-upvote-count" class="arrow-vote-count">{{ program.likes if program.likes is not none else 0 }}</span>
          </div>
          <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
            <div style="position:relative; width:64px; height:64px;">
              <img data-theme-src="/static/themes/makecore/img/arrow.svg" alt="Downvote Arrow" class="arrow-downvote-img" id="main-downvote-arrow" style="cursor:pointer; position:absolute; left:0; top:0; z-index:1; ">
              <img data-theme-src="/static/themes/makecore/img/voted.svg" alt="Downvoted Overlay" class="arrow-vote-overlay" id="main-downvote-overlay" style="display:{{ '' if user_vote == 'down' else 'none' }}; position:absolute; left:0; top:0; z-index:2; width:64px; height:64px; pointer-events:none; transform: rotate(180deg);">
            </div>
            <span id="main-downvote-count" class="arrow-vote-count">{{ program.dislikes if program.dislikes is not none else 0 }}</span>
          </div>
        </div>
        <div>Developer: <a href="/dashboard/{{ program.developer }}" style="color: var(--color7); text-decoration: none; font-weight: normal;">{{ program.developer }}</a></div>
        <div>Last Updated: <span>{{ program.last_updated.strftime('%-m/%-d/%y') }}</span></div>
        <div>Version: <span>{{ program.version }}</span></div>
        <div>Mod Perms: <span>{{ program.mod_perms or 'None' }}</span></div>
        <div class="launch-section">
          {% if program.program_url %}
          <a href="{{ program.program_url if program.program_url.startswith('http') else 'https://' + program.program_url }}" 
              class="launch-btn" 
              target="_blank" 
              style="background-color: var(--color24);"
              rel="noopener noreferrer">
              Launch
          </a>
          {% else %}
            <a href="#" class="launch-btn disabled" title="No launch URL available">Launch</a>
          {% endif %}
        </div>
      </div>
      <div style="flex:2; min-width:0;">
        <div style="font-size:1.45rem; font-weight:bold; color:var(--color7); margin-bottom:14px; margin-left: 5%;">Comments:</div>
        <div id="comments-box">
          {% for c in comments %}
            <div class="comment-row">
              <b style="color: var(--color7)">[<a href="/dashboard/{{ c.user }}" style="color: var(--color7); text-decoration: none;">{{ c.user }}</a>]</b> <span style="flex:1; color: var(--color7);">{{ c.text }}</span>
            </div>
          {% endfor %}
        </div>
        <form id="add-comment-form" onsubmit="addComment(event)">
          <input id="comment-text" type="text" placeholder="Type comment here..." required>
          <button type="submit" style="background-color: var(--color24);">Post</button>
        </form>
        <script>

          var mainUpvoteCount = {{ program.likes if program.likes is not none else 0 }};
          var mainDownvoteCount = {{ program.dislikes if program.dislikes is not none else 0 }};
          document.addEventListener('DOMContentLoaded', function() {
            let upvoted = {{ 'true' if user_vote == 'up' else 'false' }};
            let downvoted = {{ 'true' if user_vote == 'down' else 'false' }};
            const upArrow = document.getElementById('main-upvote-arrow');
            const downArrow = document.getElementById('main-downvote-arrow');
            setUpvoteState(upvoted);
            setDownvoteState(downvoted);
            if (upvoted) upArrow.classList.add('disabled');
            else upArrow.classList.remove('disabled');
            if (downvoted) downArrow.classList.add('disabled');
            else downArrow.classList.remove('disabled');


            upArrow.onclick = function() {
              if (upvoted && !downvoted) { 
                vote('up', true);
              } else if (!upvoted && !downvoted) {
                vote('up', false);
              }
            };
            downArrow.onclick = function() {
              if (downvoted && !upvoted) { 
                vote('down', true);
              } else if (!downvoted && !upvoted) {
                vote('down', false);
              }
            };

            function vote(direction, undo) {
              fetch(`/program/{{ program.id }}/vote`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({vote: direction, undo: undo})
              })
                .then(res => {
                  if (!res.ok) throw new Error('Vote request failed');
                  return res.json();
                })
                .then(data => {
                  mainUpvoteCount = data.likes;
                  mainDownvoteCount = data.dislikes;
                  document.getElementById('main-upvote-count').textContent = mainUpvoteCount;
                  document.getElementById('main-downvote-count').textContent = mainDownvoteCount;
                  if (direction === 'up') {
                    upvoted = !undo;
                    downvoted = false;
                  } else {
                    downvoted = !undo;
                    upvoted = false;
                  }
                  setUpvoteState(upvoted);
                  setDownvoteState(downvoted);
                  if (upvoted) upArrow.classList.add('disabled');
                  else upArrow.classList.remove('disabled');
                  if (downvoted) downArrow.classList.add('disabled');
                  else downArrow.classList.remove('disabled');
                })
                .catch(err => {
                  alert('Voting failed: ' + err.message);
                  console.error(err);
                });
            }


            function setUpvoteState(active) {
              const overlay = document.getElementById('main-upvote-overlay');
              overlay.style.display = active ? '' : 'none';
            }
            function setDownvoteState(active) {
              const overlay = document.getElementById('main-downvote-overlay');
              overlay.style.display = active ? '' : 'none';
            }

            upArrow.onclick = function() {
              const undo = upvoted;
              fetch(`/program/{{ program.id }}/vote`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({vote: 'up', undo: undo})
              })
                .then(res => {
                  if (!res.ok) throw new Error('Vote request failed');
                  return res.json();
                })
                .then(data => {
                  mainUpvoteCount = data.likes;
                  document.getElementById('main-upvote-count').textContent = mainUpvoteCount;
                  upvoted = !upvoted;
                  setUpvoteState(upvoted);
                })
                .catch(err => {
                  alert('Voting failed: ' + err.message);
                  console.error(err);
                });
              setUpvoteState(upvoted);
            };

            downArrow.onclick = function() {
              const undo = downvoted;
              fetch(`/program/{{ program.id }}/vote`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({vote: 'down', undo: undo})
              })
                .then(res => {
                  if (!res.ok) throw new Error('Vote request failed');
                  return res.json();
                })
                .then(data => {
                  mainUpvoteCount = data.likes;
                  mainDownvoteCount = data.dislikes;
                  document.getElementById('main-upvote-count').textContent = mainUpvoteCount;
                  document.getElementById('main-downvote-count').textContent = mainDownvoteCount;
                  downvoted = !downvoted;
                  setDownvoteState(downvoted);
                })
                .catch(err => {
                  alert('Voting failed: ' + err.message);
                  console.error(err);
                });
              setDownvoteState(downvoted);
            };

            setUpvoteState(upvoted);
            setDownvoteState(downvoted);
          });

          
          function addComment(e) {
            e.preventDefault();
            let user = '{{ username }}';
            if (!user || user === 'None') user = 'Anonymous';
            const text = document.getElementById('comment-text').value.trim();
            if (!text) return;
            fetch(`/program/{{ program.id }}/comment`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({content: text})
            })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  const box = document.getElementById('comments-box');
                  const div = document.createElement('div');
                  div.className = 'comment-row';
                  div.innerHTML = `<b style="color: var(--color7)">[<a href="/dashboard/${data.user}" style="color: var(--color7); text-decoration: none;">${data.user}</a>]</b> <span style="flex:1; color: var(--color7);">${data.text}</span>`;
                  box.appendChild(div);
                  document.getElementById('add-comment-form').reset();
                  box.scrollTop = box.scrollHeight;
                } else {
                  alert('Failed to post comment: ' + (data.error || 'Unknown error'));
                }
              })
              .catch(err => {
                alert('Failed to post comment: ' + err.message);
              });
          }
        </script>
      </div>
    </div>
  </div>
{% endblock %}
</html>
